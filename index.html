function saveVideo() {
  if (savingInProgress) return;
  savingInProgress = true;

  saveNotice.innerText =
    "Recording 5 more seconds before saving...";
  saveNotice.style.display = "block";

  // Make a fresh copy of current buffer
  const bufferCopy = buffer.slice();

  // Temporary array to collect the extra 5 seconds
  const extraChunks = [];

  // Event listener to collect extra chunks
  const onExtraData = (e) => {
    if (e.data.size > 0) extraChunks.push(e.data);
  };

  recorder.addEventListener("dataavailable", onExtraData);

  // Wait 5 seconds to get extra video
  saveTimeout = setTimeout(() => {
    recorder.removeEventListener("dataavailable", onExtraData);

    const allChunks = bufferCopy.concat(extraChunks);
    const blob = new Blob(allChunks, { type: mimeType });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "ridecam_" + new Date().toISOString().replace(/[:.]/g, "-") + ".webm";
    a.click();

    showSavedPopup();
    saveNotice.style.display = "none";
    savingInProgress = false;

    if (stopRequestedDuringSave) {
      stopRequestedDuringSave = false;
      stopCamera();
    }

  }, 5000);
}
